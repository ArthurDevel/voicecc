# TTS/STT Provider System

## Goal

Make TTS and STT modular by introducing a provider abstraction. Each provider (local or remote) implements a common interface. The user picks providers and configures API keys via the dashboard. Local model installation moves from postinstall to on-demand setup triggered from the dashboard.

---

## File Tree

```
sidecar/
  tts.ts                          (MODIFIED) - rename createTts -> createLocalTts, export bufferSentences + writePcm as shared utils
  tts-elevenlabs.ts               (NEW) - ElevenLabs TTS provider implementing TtsPlayer
  tts-provider.ts                 (NEW) - TtsProvider factory + ProviderStatus check
  stt.ts                          (MODIFIED) - rename createStt -> createLocalStt
  stt-elevenlabs.ts               (NEW) - ElevenLabs STT provider implementing SttProcessor (batch mode)
  stt-provider.ts                 (NEW) - SttProvider factory + ProviderStatus check
  types.ts                        (MODIFIED) - add provider config types; TtsConfig and VoiceLoopConfig stay unchanged
  voice-session.ts                (MODIFIED) - use TTS factory, update VoiceSessionConfig
  voice-loop-bugs.test.ts         (MODIFIED) - update createTts -> createLocalTts imports
  index.ts                        (MODIFIED) - read provider selection from env, build TtsProviderConfig
  twilio-server.ts                (MODIFIED) - update DEFAULT_CONFIG to use TtsProviderConfig
  browser-server.ts               (MODIFIED) - update DEFAULT_CONFIG to use TtsProviderConfig

services/
  env.ts                          (UNCHANGED)

dashboard/
  server.ts                       (MODIFIED) - mount /api/providers route group
  routes/
    settings.ts                   (MODIFIED) - add ELEVENLABS_API_KEY to masked keys
    providers.ts                  (NEW) - API routes for provider status + local model setup
  src/
    pages/Settings.tsx            (MODIFIED) - add "Voice" tab to tab union + rendering
    components/SettingsPanel.tsx   (UNCHANGED)
    components/VoiceProvidersPanel.tsx (NEW) - provider selection + status UI

scripts/
  postinstall.js                  (MODIFIED) - remove Python/espeak/mic-vpio setup, keep only dashboard build + CLAUDE.md
  setup-local-tts.js              (NEW) - on-demand local TTS setup (mic-vpio, Python venv, mlx-audio, espeak)
  setup-local-stt.js              (NEW) - on-demand local STT setup (Whisper model download)
```

---

## Types and Methods Per File

### sidecar/types.ts (MODIFIED)

#### New Types

```
TtsProviderType = "local" | "elevenlabs"

SttProviderType = "local" | "elevenlabs"

ProviderStatus {
  ready: boolean
  reason?: "not_installed" | "missing_api_key" | "unsupported_platform"
  detail?: string
}

TtsProviderConfig {
  provider: TtsProviderType
  local: { model: string, voice: string }
  elevenlabs: { apiKey: string, voiceId: string, modelId: string }
}

SttProviderConfig {
  provider: SttProviderType
  local: { modelPath: string }
  elevenlabs: { apiKey: string, modelId: string }
}
```

#### Unchanged Types

- `TtsConfig` -- stays as-is. Used by `createLocalTts` and tests. Not replaced by `TtsProviderConfig` (different purpose: `TtsConfig` is the internal config for the local subprocess, `TtsProviderConfig` selects which provider to use).
- `VoiceLoopConfig` -- unused dead code. Leave it alone, out of scope.

#### Modified Types

- `VoiceSessionConfig` (in voice-session.ts): replace `ttsModel: string`, `ttsVoice: string` with `ttsProvider: TtsProviderConfig`. Replace `sttModelPath: string` with `sttProvider: SttProviderConfig`.

---

### sidecar/tts-provider.ts (NEW)

Factory module that resolves the active TTS provider and checks readiness.

Note: `TtsPlayer` interface stays exported from `tts.ts`. Both `tts-provider.ts` and `tts-elevenlabs.ts` import it from there.

#### Types

```
TtsProviderInfo {
  type: TtsProviderType
  name: string
  description: string
  requiresPlatform?: "darwin"
  requiresApiKey?: string
}

CreateTtsOptions {
  providerConfig: TtsProviderConfig
  speakerInput: Writable
  interruptPlayback: () => void
  resumePlayback: () => void
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createTtsForProvider` | `options: CreateTtsOptions` | `Promise<TtsPlayer>` | Factory that creates a TtsPlayer for the configured provider. Routes to `createLocalTts` or `createElevenlabsTts` based on `options.providerConfig.provider`. |
| `getTtsProviderStatus` | `providerType: TtsProviderType` | `Promise<ProviderStatus>` | Checks readiness. Local: checks `process.platform === "darwin"`, Python venv exists, mic-vpio binary exists. ElevenLabs: checks `ELEVENLABS_API_KEY` is set in .env (uses `readEnv()` from `services/env.ts` since this runs in the dashboard process). |
| `getAvailableTtsProviders` | none | `TtsProviderInfo[]` | Returns static list of all known TTS providers with metadata. |

---

### sidecar/tts.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| `createTts` -> `createLocalTts` | Rename export to clarify it is the local provider |
| Export `bufferSentences` | Make the sentence buffering generator public so `tts-elevenlabs.ts` can reuse it |
| Export `writePcm` | Make the backpressure-aware PCM write public so `tts-elevenlabs.ts` can reuse it |
| File doc comment | Update to reference it as "local Kokoro TTS provider" |

---

### sidecar/tts-elevenlabs.ts (NEW)

ElevenLabs TTS provider. Uses their streaming HTTP API to generate audio and outputs PCM to the speaker stream.

#### Types

```
ElevenlabsTtsConfig {
  apiKey: string
  voiceId: string
  modelId: string
  speakerInput: Writable
  interruptPlayback: () => void
  resumePlayback: () => void
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createElevenlabsTts` | `config: ElevenlabsTtsConfig` | `Promise<TtsPlayer>` | Creates a TtsPlayer that calls the ElevenLabs text-to-speech streaming API. Returns PCM audio at 24kHz to match the speaker pipeline. No subprocess needed. |

---

### sidecar/stt.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| `createStt` -> `createLocalStt` | Rename export to clarify it is the local provider |
| File doc comment | Update to reference it as "local Whisper STT provider" |

Note: `SttProcessor` interface stays exported from `stt.ts`. `stt-provider.ts` and `stt-elevenlabs.ts` import it from there.

---

### sidecar/stt-elevenlabs.ts (NEW)

ElevenLabs STT provider using their batch transcription API (Scribe v2). Implements `SttProcessor` by accumulating audio locally, then sending the full buffer to ElevenLabs on `transcribe()`.

#### Types

```
ElevenlabsSttConfig {
  apiKey: string
  modelId: string
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createElevenlabsStt` | `config: ElevenlabsSttConfig` | `Promise<SttProcessor>` | Creates an SttProcessor that accumulates audio locally and sends it to the ElevenLabs batch STT API on `transcribe()`. Uses `POST https://api.elevenlabs.io/v1/speech-to-text` with the audio buffer as a WAV file. |

#### Implementation Notes

- `accumulate(samples)`: same as local -- push Float32Array chunks to internal buffer
- `transcribe()`: concatenate chunks, encode as WAV (16kHz mono 16-bit), POST to ElevenLabs STT API, return `{ text, isFinal: true, timestamp }`
- `clearBuffer()`: clear accumulated chunks (same as local)
- `destroy()`: clear buffer, no resources to release
- ElevenLabs STT API accepts audio files (WAV, MP3, etc.) -- we send WAV since we already have raw PCM

---

### sidecar/stt-provider.ts (NEW)

Factory module that resolves the active STT provider and checks readiness.

#### Types

```
SttProviderInfo {
  type: SttProviderType
  name: string
  description: string
  requiresPlatform?: "darwin"
  requiresApiKey?: string
}

CreateSttOptions {
  providerConfig: SttProviderConfig
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createSttForProvider` | `options: CreateSttOptions` | `Promise<SttProcessor>` | Factory that creates an SttProcessor for the configured provider. Routes to `createLocalStt` or `createElevenlabsStt` based on `options.providerConfig.provider`. |
| `getSttProviderStatus` | `providerType: SttProviderType` | `Promise<ProviderStatus>` | Checks readiness. Local: checks model files exist at expected path. |
| `getAvailableSttProviders` | none | `SttProviderInfo[]` | Returns static list of all known STT providers with metadata. |

---

### sidecar/voice-session.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Import `createTtsForProvider` from `tts-provider.ts` instead of `createTts` from `tts.ts` | Use TTS factory |
| Import `createSttForProvider` from `stt-provider.ts` instead of `createStt` from `stt.ts` | Use STT factory |
| TTS init block (lines 479-485) | Replace `createTts({ model: config.ttsModel, voice: config.ttsVoice, speakerInput, interruptPlayback, resumePlayback })` with `createTtsForProvider({ providerConfig: config.ttsProvider, speakerInput: speakerWritable, interruptPlayback: () => adapter.interrupt(), resumePlayback: () => adapter.resume() })` |
| STT init block (line 496) | Replace `createStt(config.sttModelPath)` with `createSttForProvider({ providerConfig: config.sttProvider })` |
| `VoiceSessionConfig` interface | Replace `ttsModel: string` and `ttsVoice: string` with `ttsProvider: TtsProviderConfig`. Replace `sttModelPath: string` with `sttProvider: SttProviderConfig`. |

---

### sidecar/voice-loop-bugs.test.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Import `createLocalTts` instead of `createTts` | Follow rename. Tests construct `TtsConfig` directly and call the local provider, not the factory. |

---

### sidecar/index.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Read `TTS_PROVIDER`, `STT_PROVIDER` from env | Determine which providers to use (default: "local" for both) |
| Read `ELEVENLABS_API_KEY`, `ELEVENLABS_VOICE_ID`, `ELEVENLABS_MODEL_ID`, `ELEVENLABS_STT_MODEL_ID` from env | ElevenLabs config values (API key is shared between TTS and STT) |
| Build `TtsProviderConfig` and `SttProviderConfig` | Construct provider config objects from env vars |
| DEFAULT_CONFIG | Replace `ttsModel`/`ttsVoice` with `ttsProvider: TtsProviderConfig`, replace `sttModelPath` with `sttProvider: SttProviderConfig` |

---

### sidecar/twilio-server.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| DEFAULT_CONFIG | Replace `ttsModel`/`ttsVoice` with `ttsProvider: TtsProviderConfig`, replace `sttModelPath` with `sttProvider: SttProviderConfig` (reads from env like index.ts) |

---

### sidecar/browser-server.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| DEFAULT_CONFIG | Replace `ttsModel`/`ttsVoice` with `ttsProvider: TtsProviderConfig`, replace `sttModelPath` with `sttProvider: SttProviderConfig` (reads from env like index.ts) |

---

### dashboard/server.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Import `providersRoutes` | Import from `./routes/providers.js` |
| Mount route | Add `app.route("/api/providers", providersRoutes())` |

---

### dashboard/routes/providers.ts (NEW)

API routes for provider status and on-demand setup.

#### Routes

| Route | Method | Returns | Description |
|-------|--------|---------|-------------|
| `/tts` | GET | `{ providers: TtsProviderInfo[], active: string }` | List all TTS providers with their status (calls `getTtsProviderStatus` for each) |
| `/tts/status/:type` | GET | `ProviderStatus` | Check readiness of a specific TTS provider |
| `/stt` | GET | `{ providers: SttProviderInfo[], active: string }` | List all STT providers with their status (calls `getSttProviderStatus` for each) |
| `/stt/status/:type` | GET | `ProviderStatus` | Check readiness of a specific STT provider |
| `/setup/local-tts` | POST | `{ success: boolean }` | Trigger on-demand local TTS setup (Python venv, packages, mic-vpio, espeak) |
| `/setup/local-stt` | POST | `{ success: boolean }` | Trigger on-demand local STT setup (Whisper model download) |

---

### dashboard/routes/settings.ts (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Add `ELEVENLABS_API_KEY` to `MASKED_KEYS` | Mask the API key in GET responses |

---

### dashboard/src/pages/Settings.tsx (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Add `"voice"` to tab union type | `"general" \| "voice" \| "integrations" \| "system"` |
| Add Voice tab button | Between General and Integrations & MCP |
| Import and render `VoiceProvidersPanel` | Show provider selection when activeTab === "voice" |

---

### dashboard/src/components/VoiceProvidersPanel.tsx (NEW)

React component for provider selection and status display.

#### UI Structure

- **TTS Provider** section:
  - Radio buttons for each provider (Local Kokoro, ElevenLabs)
  - Status badge per provider (Ready / Not Installed / Missing API Key / Unsupported Platform)
  - For Local: "Setup" button (triggers POST /api/providers/setup/local-tts) if not installed
  - For ElevenLabs: API key input field (masked), voice ID input, model ID input
- **STT Provider** section:
  - Radio buttons for each provider (Local Whisper, ElevenLabs Scribe)
  - Status badge per provider (Ready / Not Installed / Missing API Key / Unsupported Platform)
  - For Local: "Setup" button if not installed (triggers POST /api/providers/setup/local-stt)
  - For ElevenLabs: uses same API key as TTS (shared `ELEVENLABS_API_KEY`), STT model ID input
- Save button that writes `TTS_PROVIDER`, `STT_PROVIDER`, `ELEVENLABS_API_KEY`, `ELEVENLABS_VOICE_ID`, `ELEVENLABS_MODEL_ID`, `ELEVENLABS_STT_MODEL_ID` to .env via POST /api/settings

---

### scripts/postinstall.js (MODIFIED)

#### Changes

| Change | Description |
|--------|-------------|
| Remove `compileMicVpio()` | Moved to on-demand setup |
| Remove `checkSystemDeps()` | Moved to on-demand setup |
| Remove `setupPythonVenv()` | Moved to on-demand setup |
| Remove `installPythonPackages()` | Moved to on-demand setup |
| Remove `downloadSpacyModel()` | Moved to on-demand setup |
| `needsSetup()` | Only check dashboard build |
| `runSetup()` | Only install CLAUDE.md + build dashboard |

---

### scripts/setup-local-tts.js (NEW)

On-demand setup for local TTS. Extracted from postinstall.js.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `setupLocalTts` | none | `void` | Runs: check platform is darwin, compile mic-vpio, check espeak-ng, create Python venv, install mlx-audio + deps, download spaCy model. Throws on failure with actionable message. |
| `isLocalTtsInstalled` | none | `boolean` | Checks if Python venv exists AND mic-vpio binary exists |

---

### scripts/setup-local-stt.js (NEW)

On-demand setup for local STT.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `setupLocalStt` | none | `void` | Downloads Whisper ONNX model files to ~/.claude-voice-models/whisper-small/ |
| `isLocalSttInstalled` | none | `boolean` | Checks if all 3 model files exist at expected path |

---

## Important Technical Notes

### ElevenLabs PCM Streaming

ElevenLabs supports `output_format=pcm_24000` which outputs raw signed 16-bit little-endian PCM at 24kHz. This matches our speaker pipeline exactly (same format as tts-server.py output), so no resampling or format conversion is needed. The HTTP response is a chunked stream -- we read it in chunks and write directly to `speakerInput` using the shared `writePcm` utility.

### ElevenLabs STT: Batch Mode (Current) vs Realtime (Future)

This plan implements ElevenLabs STT using their **batch transcription API** (`POST /v1/speech-to-text`). Audio is accumulated locally during speech, then the full buffer is sent to ElevenLabs on `transcribe()`. This fits the existing `SttProcessor` interface (`accumulate` + `transcribe`) without any changes.

**Future improvement**: ElevenLabs also offers a **realtime WebSocket STT** (Scribe v2 Realtime, ~150ms latency) that streams audio continuously and returns partial transcripts. This would be lower latency but requires rethinking the `SttProcessor` interface -- instead of `accumulate` + `transcribe`, it would push results via callbacks. This is out of scope for this plan but should be considered as a future provider variant (e.g. `SttProviderType = "elevenlabs-realtime"`).

### ElevenLabs Shared API Key

The `ELEVENLABS_API_KEY` is shared between ElevenLabs TTS and ElevenLabs STT. The user only needs to enter it once. The `TtsProviderConfig.elevenlabs.apiKey` and `SttProviderConfig.elevenlabs.apiKey` both read from the same env var.

### ElevenLabs Rate Limits

ElevenLabs applies per-subscription rate limits (e.g. 2-10 concurrent requests depending on tier). Since `speakStream` sends one sentence at a time sequentially, concurrent request limits should not be hit in normal usage. On HTTP 429, the provider should log the error and throw -- do not implement retry logic (fail fast per coding guidelines).

### Sentence Buffering Reuse

The `bufferSentences` async generator and `writePcm` helper in `tts.ts` are useful for all TTS providers. Export them from `tts.ts` so `tts-elevenlabs.ts` can import and reuse the same logic. No need to extract to a separate file.

### Provider Switch Requires Session Restart

Changing the active provider in the dashboard takes effect on the next voice session start. No hot-swapping mid-session. This is consistent with how other config changes already work.

### Platform Checks for Local Providers

Local TTS (mlx-audio) requires macOS + Apple Silicon. Local audio (mic-vpio) requires macOS. These checks happen in `getTtsProviderStatus()` via `process.platform` check. On non-macOS, local providers show `{ ready: false, reason: "unsupported_platform" }`.

### First-Run UX After Slimmed Postinstall

Since postinstall no longer sets up local models, `sidecar/index.ts` must fail fast with a clear error message if a local provider is selected but not installed. The error should say: "Local TTS is not set up. Run setup from the dashboard (Settings > Voice) or set TTS_PROVIDER=elevenlabs in .env". Same for STT: `createStt` already throws if model files are missing -- the existing error message is sufficient.

### Dashboard vs Sidecar Process Context

`getTtsProviderStatus` is called from `dashboard/routes/providers.ts` (dashboard process) to check provider readiness. The dashboard process does NOT load `.env` via `dotenv/config` -- it uses `readEnv()` from `services/env.ts` to read the `.env` file on each request. So `getTtsProviderStatus` must accept an `EnvRecord` parameter (or call `readEnv()` internally) rather than reading `process.env`. The sidecar processes (`index.ts`, `twilio-server.ts`, `browser-server.ts`) load `.env` via `dotenv/config` at startup, so they read `process.env` directly when building `TtsProviderConfig`.

### Shared DEFAULT_CONFIG Duplication

`index.ts`, `twilio-server.ts`, and `browser-server.ts` all have nearly identical `DEFAULT_CONFIG` objects. This plan keeps them separate (each reads from env independently) because they have different `interruptionThresholdMs` values and are separate entry points. Extracting a shared config builder is out of scope but could be done later.

---

## Phases

### Phase 1: Provider Interfaces and Factories

1. Add new types to `sidecar/types.ts` (`TtsProviderType`, `SttProviderType`, `ProviderStatus`, `TtsProviderConfig`, `SttProviderConfig`)
2. Rename `createTts` to `createLocalTts` in `sidecar/tts.ts`, export `bufferSentences` and `writePcm`
3. Rename `createStt` to `createLocalStt` in `sidecar/stt.ts`
4. Update `sidecar/voice-loop-bugs.test.ts`: change `createTts` imports to `createLocalTts`
5. Create `sidecar/tts-provider.ts` with `createTtsForProvider` factory and `getTtsProviderStatus`
6. Create `sidecar/stt-provider.ts` with `createSttForProvider` factory and `getSttProviderStatus`
7. Update `sidecar/voice-session.ts`: change `VoiceSessionConfig` to use `ttsProvider: TtsProviderConfig` and `sttProvider: SttProviderConfig`, import from factories
8. Update `sidecar/index.ts`: build `TtsProviderConfig` and `SttProviderConfig` from env vars
9. Update `sidecar/twilio-server.ts`: update DEFAULT_CONFIG to use provider configs
10. Update `sidecar/browser-server.ts`: update DEFAULT_CONFIG to use provider configs
11. Verify existing local TTS + STT still works end-to-end

### Phase 2: ElevenLabs Providers

1. Create `sidecar/tts-elevenlabs.ts` implementing `TtsPlayer` via ElevenLabs streaming TTS API
2. Register it in `sidecar/tts-provider.ts` factory switch
3. Create `sidecar/stt-elevenlabs.ts` implementing `SttProcessor` via ElevenLabs batch STT API (Scribe v2)
4. Register it in `sidecar/stt-provider.ts` factory switch
5. Test TTS with `TTS_PROVIDER=elevenlabs` in .env
6. Test STT with `STT_PROVIDER=elevenlabs` in .env

### Phase 3: On-Demand Setup

1. Create `scripts/setup-local-tts.js` (extract from postinstall.js)
2. Create `scripts/setup-local-stt.js`
3. Slim down `scripts/postinstall.js` to dashboard-build-only
4. Create `dashboard/routes/providers.ts` with status + setup endpoints
5. Mount routes in `dashboard/server.ts`
6. Add `ELEVENLABS_API_KEY` to masked keys in `dashboard/routes/settings.ts`

### Phase 4: Dashboard UI

1. Create `dashboard/src/components/VoiceProvidersPanel.tsx`
2. Add "Voice" tab to `dashboard/src/pages/Settings.tsx` (add to tab union type, button, and conditional render)

---

## Success Criteria

- Existing local TTS/STT works exactly as before (default provider = "local")
- Setting `TTS_PROVIDER=elevenlabs` + valid `ELEVENLABS_API_KEY` in .env switches TTS to ElevenLabs
- Setting `STT_PROVIDER=elevenlabs` + valid `ELEVENLABS_API_KEY` in .env switches STT to ElevenLabs (batch mode)
- Dashboard shows provider status (ready / not installed / missing API key / unsupported platform)
- Dashboard allows switching providers and entering API keys
- Local model setup can be triggered from the dashboard (no longer required at install time)
- `npm install` no longer requires Python, espeak-ng, or swiftc
- Adding a new TTS or STT provider in the future only requires: (1) new implementation file implementing `TtsPlayer` or `SttProcessor`, (2) register in the corresponding factory, (3) add to provider info list

# Decouple audio capture setup from TTS setup

## Goal

The `setup-local-tts.js` script currently compiles `mic-vpio` (a macOS audio capture binary) as part of TTS setup. This is wrong -- mic-vpio is an audio capture concern, not a TTS concern. On Linux, the audio capture equivalents (`parec`, `pacat`, `module-echo-cancel`) are never validated during install.

This plan:
1. Moves audio capture setup into a standalone `setupAudioCapture()` that runs on every `voicecc` invocation (idempotent)
2. Fixes `isLocalTtsInstalled()` to only check TTS-related files (not mic-vpio)
3. Fixes `getTtsProviderStatus()` to not check for mic-vpio
4. Adds Linux audio dependency validation on startup

## File tree

```
scripts/
  postinstall.js                (MODIFIED) Add setupAudioCapture() export, add compileMicVpio() + checkLinuxAudioDeps() + commandExists()
  setup-local-tts.js            (MODIFIED) Remove compileMicVpio(), remove MIC_VPIO constant, fix isLocalTtsInstalled()
sidecar/
  tts-provider.ts               (MODIFIED) Remove MIC_VPIO_PATH constant + check from getTtsProviderStatus()
  audio-capture-darwin.ts       (NO CHANGE) Uses mic-vpio at runtime -- confirmed no changes needed
bin/
  voicecc.js                    (MODIFIED) Call setupAudioCapture() on every invocation, update JSDoc
dashboard/
  routes/providers.ts           (NO CHANGE) POST /setup/local-tts no longer compiles mic-vpio as side effect (intended)
```

## Per-file methods and types

### scripts/postinstall.js (MODIFIED)

Adds `setupAudioCapture()` as a new export. This is NOT called from `runSetup()` -- it's called directly from `voicecc.js` on every invocation (before starting the dashboard). This way it always runs regardless of whether `needsSetup()` returns true, since the checks are cheap and idempotent.

`needsSetup()` and `runSetup()` remain unchanged.

#### New constants

```
MIC_VPIO = join("sidecar", "mic-vpio")
MIC_VPIO_SOURCE = join("sidecar", "mic-vpio.swift")
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `needsSetup` | none | `boolean` | UNCHANGED. Only checks dashboard build status. |
| `runSetup` | none | `void` | UNCHANGED. installClaudeMd + buildDashboard. |
| `setupAudioCapture` | none | `void` | NEW (exported). On macOS: calls `compileMicVpio()` wrapped in try/catch (logs error, does not re-throw). On Linux: calls `checkLinuxAudioDeps()`. Never throws -- dashboard always starts. |
| `compileMicVpio` | none | `void` | NEW (moved from setup-local-tts.js). Checks `existsSync(MIC_VPIO)` first (idempotent). Compiles the mic-vpio Swift binary. Throws if swiftc not found or compilation fails. |
| `commandExists` | `cmd: string` | `boolean` | NEW. Synchronous check using `execSync('command -v ...')` (same as setup-local-tts.js version). |
| `checkLinuxAudioDeps` | none | `void` | NEW. Checks for `parec`/`pacat` (audio capture) and `pactl` (needed to load module-echo-cancel) via `commandExists()`. Prints warnings with `sudo apt install pulseaudio-utils` instructions for missing binaries. Prints a static reminder about loading `module-echo-cancel` (does NOT query `pactl list short sources` -- see technical notes). |

### scripts/setup-local-tts.js (MODIFIED)

Remove `compileMicVpio()` call from `setupLocalTts()` and the `compileMicVpio` function entirely. Remove `MIC_VPIO` constant. Fix `isLocalTtsInstalled()` to only check for Python venv.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `setupLocalTts` | none | `void` | MODIFIED. Remove `compileMicVpio()` call. Steps become: check platform -> check espeak-ng -> create Python venv -> install packages -> download spaCy model |
| `isLocalTtsInstalled` | none | `boolean` | MODIFIED. Only checks `existsSync(PYTHON)`. No longer checks for mic-vpio. |

Removed methods:
- `compileMicVpio` -- moved to `postinstall.js`

Removed constants:
- `MIC_VPIO` -- no longer relevant to this file

### sidecar/tts-provider.ts (MODIFIED)

Remove the mic-vpio existence check from `getTtsProviderStatus()`. mic-vpio is an audio capture binary, not a TTS dependency. Local TTS readiness should only check for the Python venv.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `getTtsProviderStatus` | `providerType: TtsProviderType` | `Promise<ProviderStatus>` | MODIFIED. For "local": keep platform check (darwin-only) and Python venv check. Remove `existsSync(MIC_VPIO_PATH)` check. |

Removed constants:
- `MIC_VPIO_PATH` -- no longer needed in this file

### bin/voicecc.js (MODIFIED)

Add `setupAudioCapture` to the existing destructured dynamic import: `const { needsSetup, runSetup, setupAudioCapture } = await import("../scripts/postinstall.js");`. Call it after the `needsSetup`/`runSetup` block, before spawning the dashboard. Update file-level JSDoc.

## Technical notes

### setupAudioCapture() runs on every invocation, not just first-run

`setupAudioCapture()` is called from `voicecc.js` independently of `needsSetup()` / `runSetup()`. This is because:
- On macOS, `compileMicVpio()` is idempotent (exits early if binary exists via `existsSync`)
- On Linux, the checks are just `command -v` calls (fast, ~5ms total)
- This ensures Linux users always see warnings about missing deps, not just on first run

### Linux audio validation is warning-only, not blocking

On Linux, `checkLinuxAudioDeps()` prints warnings but does NOT throw or exit. This is because:
- The user may want to use browser/Twilio audio (which doesn't need parec/pacat)
- The dashboard should always start so the user can configure providers
- The actual hard errors happen at runtime in `audio-capture-linux.ts` with actionable messages

On macOS, `compileMicVpio()` throws on failure, but `setupAudioCapture()` wraps it in a try/catch and logs the error without re-throwing. The dashboard still starts. Note: `compileMicVpio()` uses `run()` with `stdio: "inherit"`, so compilation errors already print to stderr before the catch block runs -- the catch block just adds a summary line.

### Do NOT query pactl for echo-cancel sources at install time

`checkLinuxAudioDeps()` does NOT run `pactl list short sources` to check if `module-echo-cancel` is loaded. This is because PulseAudio may not be running in the install context (SSH session, headless server, root-level npm install), and `module-echo-cancel` is loaded per-session unless explicitly persisted in `/etc/pulse/default.pa`. Instead, print a static reminder: "Note: before starting a voice session, load echo cancellation with: pactl load-module module-echo-cancel ...". The runtime check in `audio-capture-linux.ts:startCaptureLinux()` validates the echo source/sink and throws with full instructions.

### commandExists is intentionally duplicated

The new `commandExists()` in `postinstall.js` uses the same synchronous `execSync('command -v ...')` pattern already present in `setup-local-tts.js`. Both files keep their own copy rather than extracting to a shared utility -- the function is 5 lines and the scripts are self-contained. This is different from `audio-capture-linux.ts` which uses the async version (`exec`).

## Phases

### Phase 1: Move mic-vpio compilation to postinstall.js and wire into voicecc.js
- [ ] Add `MIC_VPIO` and `MIC_VPIO_SOURCE` constants to `postinstall.js`
- [ ] Add `commandExists()` helper to `postinstall.js`
- [ ] Add `compileMicVpio()` function to `postinstall.js` (moved from setup-local-tts.js, uses MIC_VPIO_SOURCE constant)
- [ ] Add `checkLinuxAudioDeps()` function to `postinstall.js`
- [ ] Add `setupAudioCapture()` function (exported) that branches on `process.platform`
- [ ] Update `voicecc.js`: import `setupAudioCapture`, call it after the `needsSetup`/`runSetup` block
- [ ] Update file-level JSDoc in both files

### Phase 2: Clean up setup-local-tts.js
- [ ] Remove `compileMicVpio()` function
- [ ] Remove `compileMicVpio()` call from `setupLocalTts()`
- [ ] Remove `MIC_VPIO` constant
- [ ] Update `isLocalTtsInstalled()` to only check `existsSync(PYTHON)`
- [ ] Update file-level JSDoc (remove mic-vpio mention)

### Phase 3: Clean up tts-provider.ts
- [ ] Remove `MIC_VPIO_PATH` constant
- [ ] Remove `existsSync(MIC_VPIO_PATH)` check from `getTtsProviderStatus()`
- [ ] Update the JSDoc comment on `getTtsProviderStatus()` (remove mic-vpio mention)

## Success criteria

- On macOS: `voicecc` checks for mic-vpio on every invocation and compiles it if missing (idempotent, no-op when binary exists)
- On Linux: `voicecc` prints warnings for missing parec/pacat/pactl with install instructions, plus a reminder about module-echo-cancel
- `isLocalTtsInstalled()` returns true when Python venv exists, regardless of mic-vpio
- `getTtsProviderStatus("local")` does not check for mic-vpio
- Dashboard starts on both platforms even if audio deps are missing
- Local TTS setup (`POST /setup/local-tts`) no longer compiles mic-vpio

# Dashboard Restructure: Vite + React + Hono

## Goal

Replace the hand-rolled HTTP server and monolithic inline-HTML dashboard with a modern stack:
- **Hono** for the API server (replaces 1282-line `dashboard/server.ts` if/else routing)
- **React + Vite** for the frontend (replaces 2200 lines of inline HTML/JS/CSS)
- **Services layer** to extract ngrok, twilio process management, and device pairing out of the dashboard server

## File Tree

```
services/                                    (NEW directory)
  env.ts                                     (NEW) shared .env parsing + writing
  ngrok.ts                                   (NEW) ngrok process lifecycle
  twilio-manager.ts                          (NEW) twilio-server process spawn/kill
  device-pairing.ts                          (NEW) pairing codes + device token store

dashboard/
  server.ts                                  (REWRITE) Hono app, mounts routes, serves Vite build
  routes/                                    (NEW directory)
    claude-md.ts                             (NEW) CLAUDE.md read/write + status warning
    conversations.ts                         (NEW) list + get conversation sessions
    settings.ts                              (NEW) .env read/write via API
    voice.ts                                 (NEW) start voice sidecar in Terminal
    ngrok.ts                                 (NEW) ngrok check/authtoken/status
    twilio.ts                                (NEW) twilio status/start/stop, phone numbers, webrtc setup, token
    webrtc.ts                                (NEW) pairing code generation, device pair, device validate
    mcp-servers.ts                           (NEW) list MCP servers from claude CLI
  vite.config.ts                             (NEW) Vite config with API proxy
  tsconfig.json                              (NEW) frontend-only tsconfig with JSX
  index.html                                 (NEW) Vite entry point
  src/                                       (NEW directory)
    main.tsx                                 (NEW) React root mount
    App.tsx                                  (NEW) React Router with / and /call routes
    api.ts                                   (NEW) shared fetch helpers for all API calls
    pages/
      Home.tsx                               (NEW) main dashboard layout (sidebar + content)
      Call.tsx                                (NEW) WebRTC browser calling page
    components/
      Sidebar.tsx                            (NEW) sidebar nav, voice button, conversation list
      ClaudeMdEditor.tsx                     (NEW) CLAUDE.md textarea with save/Cmd+S
      ConversationView.tsx                   (NEW) chat bubble message viewer
      SettingsPanel.tsx                       (NEW) .env settings form
      McpServersPanel.tsx                    (NEW) MCP server list with status dots
      TwilioPanel.tsx                        (NEW) twilio + webrtc setup modals
      BrowserCallModal.tsx                   (NEW) QR code + pairing code modal for browser calling
    index.css                                (NEW) global styles ported from inline CSS (~580 lines)
  public/                                    (DELETE) replaced by src/ components
    index.html                               (DELETE)
    call.html                                (DELETE)

run.ts                                       (MODIFY) import startDashboard from new server, import services for auto-start
package.json                                 (MODIFY) add hono, react, vite deps
tsconfig.json                                (MODIFY) exclude dashboard/src from server tsconfig, add JSX support reference
```

## Per-File Methods and Types

### services/env.ts (NEW)

#### Types

```
EnvRecord = Record<string, string>
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `parseEnvFile` | `content: string` | `EnvRecord` | Parse raw .env content into key-value pairs, skipping comments and empty lines |
| `readEnv` | `envPath?: string` | `Promise<EnvRecord>` | Read and parse the .env file from disk (defaults to `process.cwd()/.env`) |
| `writeEnvKey` | `key: string, value: string, envPath?: string` | `Promise<void>` | Update a single key in the .env file, preserving all other values |
| `writeEnvFile` | `settings: EnvRecord, envPath?: string` | `Promise<void>` | Write full settings record to .env file |

---

### services/ngrok.ts (NEW)

#### Types

```
NgrokState {
  process: ChildProcess | null
  url: string | null
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `startNgrok` | `port: number` | `Promise<string>` | Spawn ngrok, poll local API via `pollNgrokUrl` for HTTPS URL, write TWILIO_WEBHOOK_URL to .env, return public URL. Reads `NGROK_AUTHTOKEN` from .env and passes it in the child process env |
| `stopNgrok` | none | `void` | Kill ngrok process, clear state |
| `getNgrokUrl` | none | `string \| null` | Return current public ngrok URL |
| `isNgrokRunning` | none | `boolean` | Whether ngrok process is alive |
| `checkNgrokInstalled` | none | `Promise<boolean>` | Run `ngrok version` to check if installed |
| `configureNgrokAuthtoken` | `token: string` | `Promise<{ ok: boolean; output: string }>` | Run `ngrok config add-authtoken` |

Internal helper (not exported):

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `pollNgrokUrl` | `checkEarlyExit: () => string \| null, apiPort?: number` | `Promise<string>` | Poll `http://127.0.0.1:4040/api/tunnels` every 500ms for up to 10s. Returns the first HTTPS tunnel URL. Throws if ngrok exits early or times out |

---

### services/twilio-manager.ts (NEW)

Imports `readEnv` from `services/env.ts` for reading .env keys. Imports `twilio` SDK for TwiML app updates when starting the server. Accepts ngrok URL as a parameter rather than importing from ngrok service.

#### Types

```
TwilioStatus {
  running: boolean
  webrtcReady: boolean
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `startTwilioServer` | `dashboardPort: number, ngrokUrl?: string` | `Promise<void>` | Read .env for `TWILIO_AUTH_TOKEN`. If ngrokUrl + TwiML app SID exist, update TwiML app voice URL via `twilio` SDK. Spawn `twilio-server.ts` as child process with `DASHBOARD_PORT` env var |
| `stopTwilioServer` | none | `void` | Kill twilio-server process |
| `getStatus` | none | `TwilioStatus` | Return `{ running, webrtcReady }`. Derives `webrtcReady` by checking .env for `TWILIO_API_KEY_SID`, `TWILIO_API_KEY_SECRET`, and `TWILIO_TWIML_APP_SID` |
| `isRunning` | none | `boolean` | Whether twilio server process is alive |

---

### services/device-pairing.ts (NEW)

#### Types

```
PairingCode {
  expiresAt: number
  attempts: number
}

DeviceTokenInfo {
  pairedAt: number
  userAgent: string
}

PairingResult {
  code: string
  expiresAt: number
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `generatePairingCode` | none | `PairingResult` | Create 6-digit code with 5min TTL, store in memory |
| `validateAndConsumeCode` | `code: string, userAgent: string` | `{ ok: boolean; token?: string; error?: string }` | Validate code, enforce max attempts, return device token on success. Calls `saveDeviceTokens` internally on success |
| `isValidDeviceToken` | `token: string` | `boolean` | Check if a device token exists in the store |
| `loadDeviceTokens` | none | `Promise<void>` | Load persisted tokens from `.device-tokens.json` on startup. Called by `startDashboard` before mounting routes |
| `saveDeviceTokens` | none | `Promise<void>` | Persist device tokens to `.device-tokens.json` (internal, called by `validateAndConsumeCode`) |

---

### dashboard/server.ts (REWRITE)

#### Types

None (thin wiring file).

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `createApp` | none | `Hono` | Create Hono app. Mount route groups: `/api/claude-md` → claudeMdRoutes, `/api/conversations` → conversationRoutes, `/api/settings` → settingsRoutes, `/api/voice` → voiceRoutes, `/api/ngrok` → ngrokRoutes, `/api/twilio` → twilioRoutes, `/api/webrtc` → webrtcRoutes, `/api/mcp-servers` → mcpServersRoutes. Mount `GET /api/status` directly (user CLAUDE.md conflict check). Add `serveStatic` for Vite build + SPA fallback |
| `startDashboard` | none | `Promise<number>` | Call `loadDeviceTokens()` from device-pairing service, then try ports 3456-3460, start Hono via `@hono/node-server`, return bound port |

---

### dashboard/routes/claude-md.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `claudeMdRoutes` | none | `Hono` | Returns Hono instance with `GET /` (read), `POST /` (write) |

Note: The user CLAUDE.md conflict check (`GET /api/status`) is mounted separately in `server.ts` (not under `/api/claude-md`) to preserve the existing API path.

---

### dashboard/routes/conversations.ts (NEW)

#### Types

```
ConversationSummary {
  sessionId: string
  firstMessage: string
  timestamp: string
  messageCount: number
}

ConversationMessage {
  role: "user" | "assistant"
  content: string
  timestamp: string
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `conversationRoutes` | none | `Hono` | Returns Hono instance with `GET /` (list) and `GET /:sessionId` (detail) |
| `extractSessionSummary` | `filePath: string` | `Promise<{ firstUserMessage: string; messageCount: number }>` | Read JSONL, extract first user message and count (moved from old server.ts) |
| `parseSessionMessages` | `filePath: string` | `Promise<ConversationMessage[]>` | Parse all user/assistant messages with deduplication (moved from old server.ts) |

---

### dashboard/routes/settings.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `settingsRoutes` | none | `Hono` | Returns Hono instance with `GET /` (read .env, mask secrets) and `POST /` (merge write .env) |

---

### dashboard/routes/voice.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `voiceRoutes` | none | `Hono` | Returns Hono instance with `POST /start` (opens Terminal.app via osascript) |

---

### dashboard/routes/ngrok.ts (NEW)

Delegates to `services/ngrok.ts` for all ngrok operations.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `ngrokRoutes` | none | `Hono` | Returns Hono instance with: `GET /check` (is ngrok installed), `POST /authtoken` (configure authtoken), `GET /status` (running + URL), `POST /start` (start ngrok tunnel), `POST /stop` (stop ngrok tunnel) |

Route delegation:
- `GET /check` → `checkNgrokInstalled()` from `services/ngrok.ts`
- `POST /authtoken` → `configureNgrokAuthtoken(token)` from `services/ngrok.ts`
- `GET /status` → `isNgrokRunning()` + `getNgrokUrl()` from `services/ngrok.ts`
- `POST /start` → reads `TWILIO_PORT` from .env via `readEnv`, calls `startNgrok(port)` from `services/ngrok.ts`
- `POST /stop` → `stopNgrok()` from `services/ngrok.ts`

---

### dashboard/routes/twilio.ts (NEW)

Imports `twilio` SDK directly for `POST /setup-webrtc` (create API key, TwiML app) and `GET /token` (JWT AccessToken + VoiceGrant). Imports `readEnv` from `services/env.ts`.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `twilioRoutes` | none | `Hono` | Returns Hono instance with: `GET /status`, `POST /start`, `POST /stop`, `GET /phone-numbers`, `POST /setup-webrtc`, `GET /token` |

Route delegation:
- `GET /status` → `getStatus()` from `services/twilio-manager.ts`
- `POST /start` → `startTwilioServer(dashboardPort)` from `services/twilio-manager.ts`
- `POST /stop` → `stopTwilioServer()` from `services/twilio-manager.ts`
- `GET /phone-numbers` → direct `fetch` to Twilio REST API (no SDK, matches current impl)
- `POST /setup-webrtc` → uses `twilio` SDK to create API key + TwiML app, writes keys to .env
- `GET /token` → uses `twilio` SDK's `jwt.AccessToken` + `VoiceGrant` to generate token. Requires valid device token or localhost (uses `services/device-pairing.ts` for validation)

---

### dashboard/routes/webrtc.ts (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `webrtcRoutes` | none | `Hono` | Returns Hono instance with: `POST /generate-code` (localhost only), `POST /pair`, `GET /validate` |

---

### dashboard/routes/mcp-servers.ts (NEW)

#### Types

```
McpServerEntry {
  name: string
  url: string
  type: "http" | "stdio"
  status: "connected" | "failed" | "needs_auth"
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `mcpServersRoutes` | none | `Hono` | Returns Hono instance with `GET /` that runs `claude mcp list` and parses output |
| `parseMcpListOutput` | `output: string` | `McpServerEntry[]` | Parse CLI output into structured entries (moved from old server.ts) |

---

### dashboard/src/api.ts (NEW)

#### Types

```
ApiError {
  status: number
  message: string
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `get` | `path: string` | `Promise<any>` | GET request to API, throw ApiError on non-2xx |
| `post` | `path: string, body?: any` | `Promise<any>` | POST request with JSON body |

---

### dashboard/src/App.tsx (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `App` | none | `JSX.Element` | React Router setup: `/` renders Home, `/call` renders Call |

---

### dashboard/src/pages/Home.tsx (NEW)

#### Types

```
ActivePage = "settings" | "conversation"
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `Home` | none | `JSX.Element` | Main dashboard layout with Sidebar + content area. Manages active page state and selected conversation ID. Settings page renders: `SettingsPanel` + `McpServersPanel` + `ClaudeMdEditor` stacked vertically (matching current layout). Conversation page renders: `ConversationView` |

---

### dashboard/src/pages/Call.tsx (NEW)

#### Types

```
CallState = "pairing" | "ready" | "connecting" | "active"
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `Call` | none | `JSX.Element` | WebRTC calling page. PIN input, device pairing, Twilio Voice SDK call lifecycle. Loads `@twilio/voice-sdk` dynamically |

---

### dashboard/src/components/Sidebar.tsx (NEW)

#### Types

```
SidebarProps {
  activePage: ActivePage
  onPageChange: (page: ActivePage) => void
  selectedConversationId: string | null
  onSelectConversation: (id: string) => void
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `Sidebar` | `props: SidebarProps` | `JSX.Element` | Sidebar with Start Voice button, Browser Call button, conversation list, settings nav item |

---

### dashboard/src/components/ClaudeMdEditor.tsx (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `ClaudeMdEditor` | none | `JSX.Element` | Textarea editor for CLAUDE.md with load/save, Cmd+S shortcut, dirty state tracking, user CLAUDE.md conflict warning |

---

### dashboard/src/components/ConversationView.tsx (NEW)

#### Types

```
ConversationViewProps {
  sessionId: string
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `ConversationView` | `props: ConversationViewProps` | `JSX.Element` | Fetches and renders conversation messages as chat bubbles with timestamps. Auto-scrolls to bottom |

---

### dashboard/src/components/SettingsPanel.tsx (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `SettingsPanel` | none | `JSX.Element` | Form for MAX_CONCURRENT_SESSIONS with load/save. Renders integrations buttons (Twilio, WebRTC) that open TwilioPanel modals |

---

### dashboard/src/components/McpServersPanel.tsx (NEW)

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `McpServersPanel` | none | `JSX.Element` | Fetches MCP server list on mount, renders rows with status dots, name, URL, type badge |

---

### dashboard/src/components/TwilioPanel.tsx (NEW)

#### Types

```
TwilioPanelProps {
  mode: "twilio" | "webrtc"
  onClose: () => void
}

TwilioStatusData {
  running: boolean
  ngrokUrl: string | null
  webrtcReady: boolean
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `TwilioPanel` | `props: TwilioPanelProps` | `JSX.Element` | Modal overlay with step-by-step Twilio/WebRTC setup wizard. Handles credential input, ngrok check, server start/stop, WebRTC setup, phone number fetch |

---

### dashboard/src/components/BrowserCallModal.tsx (NEW)

#### Types

```
BrowserCallModalProps {
  ngrokUrl: string
  onClose: () => void
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `BrowserCallModal` | `props: BrowserCallModalProps` | `JSX.Element` | Modal overlay with QR code (via `qrcode.react`) pointing to `ngrokUrl + '/call'`, 6-digit pairing code display with countdown timer, regenerate button. Generates codes via `POST /api/webrtc/generate-code` |

---

### dashboard/vite.config.ts (NEW)

Vite configuration:
- `@vitejs/plugin-react` for JSX
- `server.proxy`: proxy `/api` requests to Hono server port during development
- `build.outDir`: `dist`

---

### dashboard/tsconfig.json (NEW)

Frontend-only tsconfig:
- `jsx: "react-jsx"`
- `module: "ESNext"`, `moduleResolution: "bundler"`
- `include: ["src"]`

---

### run.ts (MODIFY)

Changes:
- Import `startDashboard` from `dashboard/server.ts` (new Hono version)
- Import `startNgrok` from `services/ngrok.ts`
- Import `startTwilioServer` from `services/twilio-manager.ts`
- Remove local `parseEnvLines` function, import `readEnv` from `services/env.ts`
- Capture dashboard port: `const port = await startDashboard()`
- Preserve auto-start flow: read .env with `readEnv`, check `NGROK_AUTHTOKEN` → `const ngrokUrl = await startNgrok(twilioPort)`, check `TWILIO_AUTH_TOKEN` → `await startTwilioServer(port, ngrokUrl)`. The ngrok port comes from `TWILIO_PORT` in .env (default 8080), not the dashboard port

---

### package.json (MODIFY)

New dependencies:
- `hono`, `@hono/node-server` — API framework
- `react`, `react-dom`, `react-router-dom` — frontend
- `@twilio/voice-sdk` — replaces CDN script in call.html
- `qrcode.react` — QR code rendering (replaces CDN `qrcode-generator`)

New devDependencies:
- `vite`, `@vitejs/plugin-react` — build tooling
- `@types/react`, `@types/react-dom` — type definitions

New scripts:
- `dev:dashboard`: run Vite dev server for frontend HMR
- `build:dashboard`: build frontend to `dashboard/dist/`
- Modify `postinstall` to also run `npm run build:dashboard`

---

### tsconfig.json (root, MODIFY)

- Add `"services/**/*.ts"` to `include`
- Add `"dashboard/server.ts"`, `"dashboard/routes/**/*.ts"` to `include`
- Exclude `"dashboard/src"` (covered by dashboard/tsconfig.json)

## Important Technical Notes

### Hono static file serving in production

Hono serves the Vite build output using `serveStatic` from `@hono/node-server/serve-static`. The middleware is mounted at `/*` as a fallback after all API routes. For SPA client-side routing, unmatched GET requests return `index.html`:

```ts
import { readFileSync } from "fs";

app.get("*", serveStatic({ root: "./dashboard/dist" }));
// SPA fallback: serve index.html for unmatched routes (client-side routing)
app.get("*", (c) => c.html(readFileSync("./dashboard/dist/index.html", "utf-8")));
```

### Vite dev server proxy

During development, the Vite dev server runs on port 5173 and proxies all `/api` requests to the Hono server (port 3456). This gives frontend HMR while API calls hit the real server:

```ts
// dashboard/vite.config.ts
server: {
  proxy: {
    "/api": "http://localhost:3456",
  },
}
```

### Twilio Voice SDK migration

The current `call.html` loads `@twilio/voice-sdk` from a CDN `<script>` tag and accesses the global `Twilio.Device`. With React, install the npm package `@twilio/voice-sdk` and import it as an ES module in `Call.tsx`. The SDK must be loaded lazily (dynamic import) because it accesses browser APIs not available during SSR/build.

### Hono localhost check middleware

Several routes need localhost-only access (pairing code generation). Create a reusable Hono middleware:

```ts
const localhostOnly: MiddlewareHandler = async (c, next) => {
  const addr = c.req.raw.headers.get("x-forwarded-for") ?? c.env?.ip ?? "";
  // In @hono/node-server, access socket via connInfo
  // Use getConnInfo from @hono/node-server
  ...
};
```

Use `getConnInfo` from `@hono/node-server` to get the remote address, then check for `127.0.0.1`, `::1`, or `::ffff:127.0.0.1`.

### Device pairing state persistence

`services/device-pairing.ts` keeps pairing codes in memory (ephemeral, 5min TTL) and device tokens in memory + disk (`.device-tokens.json`). The purge interval (60s) for expired codes runs via `setInterval` — start it in the module's top-level scope so it activates on first import.

### Conversation JSONL parsing

The `extractSessionSummary` and `parseSessionMessages` functions use Node.js `readline` with `createReadStream` for memory-efficient line-by-line JSONL parsing. These move to `dashboard/routes/conversations.ts` unchanged. They handle deduplication of assistant messages by `requestId` (the SDK emits multiple partial messages).

### Call page routing through ngrok proxy

The current QR code points to `ngrokUrl + '/call.html'`. After migration, the call page is a React SPA route at `/call`. Two things must change:
1. `BrowserCallModal.tsx` must generate the URL as `ngrokUrl + '/call'` (no `.html`)
2. The SPA fallback in Hono must work when the request arrives via the twilio-server proxy path: browser → ngrok → `twilio-server.ts` (port 8080) → proxy to dashboard Hono (port 3456). The proxy in `twilio-server.ts` forwards the full path, so `/call` will hit the Hono server which serves `index.html` via the SPA fallback. This works without changes to `twilio-server.ts`.

### `parseEnvFile` must match current behavior

The current `run.ts` `parseEnvLines` skips empty values (`if (value) result[key] = value`), while `dashboard/server.ts` `parseEnvFile` keeps them (`result[key] = value`). The shared `parseEnvFile` in `services/env.ts` should keep empty values (match `dashboard/server.ts` behavior) since the settings API needs to preserve empty keys. The auto-start checks in `run.ts` (`if (envVars.NGROK_AUTHTOKEN)`) still work because empty strings are falsy.

The current implementation in `dashboard/server.ts` does `.trim()` on values but does **not** strip quotes. The `dotenv` library strips quotes, but this code does not use `dotenv` for runtime reads — only for initial `process.env` loading in the sidecar. `services/env.ts` must preserve this behavior (no quote stripping) to avoid regressions in .env values.

### `writeEnvKey` uses `readEnv` + `writeEnvFile` internally

To keep DRY, `writeEnvKey` should read the full .env, update the key, and write back via `writeEnvFile`. This matches the current implementation pattern.

### Status polling in React frontend

The current `index.html` polls `/api/twilio/status` every 5 seconds and updates integration dots in the sidebar + modal content. In the new architecture, ngrok and twilio status are separate endpoints. Create two hooks:
- `useNgrokStatus` — polls `GET /api/ngrok/status` every 5s, returns `{ running, url }`
- `useTwilioStatus` — polls `GET /api/twilio/status` every 5s, returns `{ running, webrtcReady }`

Used by `Sidebar.tsx` (integration dots, browser call button enable/disable) and `TwilioPanel.tsx` (modal step updates). `BrowserCallModal.tsx` uses `useNgrokStatus` for the ngrok URL in the QR code.

### ClaudeMdEditor lives within the settings page

`ClaudeMdEditor.tsx` is rendered as a section within the settings page (below integrations and MCP servers), matching the current layout in `index.html`. It is **not** a separate routable page.

### Styling approach

Port the current inline CSS (~580 lines) to a single `dashboard/src/index.css` file imported by `main.tsx`. Use the same VS Code dark theme class names. Components reference these classes directly — no CSS modules or Tailwind.

### npm package `files` array

After the restructure, `dashboard/src/` would be included in the published npm package unnecessarily (only `dashboard/dist/` is needed at runtime). Update the `files` array in `package.json` to exclude `dashboard/src/` or add `dashboard/dist/` explicitly.

## Phases

### Phase 1: Scaffold and Dependencies

- [ ] Install new dependencies: `hono`, `@hono/node-server`, `react`, `react-dom`, `react-router-dom`, `@twilio/voice-sdk`
- [ ] Install new dev dependencies: `vite`, `@vitejs/plugin-react`, `@types/react`, `@types/react-dom`
- [ ] Create `services/` directory
- [ ] Create `dashboard/routes/` directory
- [ ] Create `dashboard/src/`, `dashboard/src/pages/`, `dashboard/src/components/` directories
- [ ] Create `dashboard/vite.config.ts`
- [ ] Create `dashboard/tsconfig.json` (frontend)
- [ ] Create `dashboard/index.html` (Vite entry point with `<div id="root">` and `<script type="module" src="/src/main.tsx">`)
- [ ] Update root `tsconfig.json` (add services, exclude dashboard/src)

### Phase 2: Extract Services

- [ ] Create `services/env.ts` — extract `parseEnvFile`, `writeEnvKey` from `dashboard/server.ts`, add `readEnv` and `writeEnvFile`
- [ ] Create `services/ngrok.ts` — extract ngrok process state, `startNgrok`, `stopNgrok`, `pollNgrokUrl`, `checkNgrokInstalled`, `configureNgrokAuthtoken`
- [ ] Create `services/twilio-manager.ts` — extract twilio process state, `startTwilioServer`, `stopTwilioServer`, `getStatus`
- [ ] Create `services/device-pairing.ts` — extract pairing codes map, device tokens map, `loadDeviceTokens`, `saveDeviceTokens`, `generatePairingCode`, `validateAndConsumeCode`, `isValidDeviceToken`

### Phase 3: Hono Server and API Routes

- [ ] Rewrite `dashboard/server.ts` as Hono app — `createApp` mounts route groups, `startDashboard` listens on port
- [ ] Create `dashboard/routes/claude-md.ts` — `GET /` reads CLAUDE.md, `POST /` writes it, `GET /status` checks user CLAUDE.md
- [ ] Create `dashboard/routes/conversations.ts` — `GET /` lists sessions, `GET /:sessionId` returns messages (move JSONL parsing logic here)
- [ ] Create `dashboard/routes/settings.ts` — `GET /` reads .env with masked secrets, `POST /` merges into .env
- [ ] Create `dashboard/routes/voice.ts` — `POST /start` runs osascript to open Terminal
- [ ] Create `dashboard/routes/ngrok.ts` — ngrok check/authtoken/status/start/stop, delegates to ngrok service
- [ ] Create `dashboard/routes/twilio.ts` — twilio status/start/stop, phone numbers, webrtc setup, token, delegates to twilio-manager service
- [ ] Create `dashboard/routes/webrtc.ts` — pairing code + device validation, delegates to device-pairing service
- [ ] Create `dashboard/routes/mcp-servers.ts` — `GET /` runs `claude mcp list` and parses output
- [ ] Update `run.ts` — import from new `dashboard/server.ts` and `services/`

### Phase 4: React Frontend

- [ ] Create `dashboard/src/main.tsx` — mount React app to `#root`
- [ ] Create `dashboard/src/api.ts` — shared `get`/`post` fetch wrappers
- [ ] Create `dashboard/src/App.tsx` — React Router with `/` and `/call` routes
- [ ] Create `dashboard/src/pages/Home.tsx` — layout with sidebar + content area, active page state
- [ ] Create `dashboard/src/components/Sidebar.tsx` — nav items, voice button, browser call button, conversation list
- [ ] Create `dashboard/src/components/ClaudeMdEditor.tsx` — textarea with load/save/Cmd+S/dirty state
- [ ] Create `dashboard/src/components/ConversationView.tsx` — chat bubble renderer
- [ ] Create `dashboard/src/components/SettingsPanel.tsx` — settings form + integration buttons
- [ ] Create `dashboard/src/components/McpServersPanel.tsx` — MCP server list with status dots
- [ ] Create `dashboard/src/components/TwilioPanel.tsx` — modal wizard for Twilio + WebRTC setup
- [ ] Create `dashboard/src/components/BrowserCallModal.tsx` — QR code + pairing code modal
- [ ] Create `dashboard/src/index.css` — port ~580 lines of inline CSS from index.html + call.html
- [ ] Create `dashboard/src/pages/Call.tsx` — PIN input, pairing, Twilio Voice SDK call lifecycle

### Phase 5: Build, Wire, and Clean Up

- [ ] Add `build:dashboard` and `dev:dashboard` scripts to package.json
- [ ] Update `postinstall` to run Vite build
- [ ] Build frontend and verify Hono serves it correctly
- [ ] Delete `dashboard/public/index.html`
- [ ] Delete `dashboard/public/call.html`
- [ ] Delete `dashboard/public/` directory
- [ ] Verify `npm start` boots dashboard with all features working
- [ ] Verify Vite dev server + API proxy works for frontend development

## Success Criteria

- `npm start` boots the Hono server, serves the React dashboard at `http://localhost:3456`
- All existing API endpoints return identical responses
- CLAUDE.md editor loads, saves, and supports Cmd+S
- Conversation list populates in sidebar, clicking opens message viewer
- Settings panel reads/writes .env
- MCP servers panel shows status
- Twilio setup modal wizard works end-to-end (credentials, ngrok, server start/stop, webhook URL display, phone number fetch)
- WebRTC setup modal works (credentials, server start, browser calling setup)
- "Start Voice" button opens Terminal with sidecar
- "Call via Browser" shows QR + pairing code modal, `/call` page pairs and connects via WebRTC
- `npm run dev:dashboard` starts Vite with HMR, proxied API calls work
- No regressions: sidecar voice pipeline untouched, twilio-server.ts untouched

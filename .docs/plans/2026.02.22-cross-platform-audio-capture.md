# Cross-Platform Audio Capture

## Goal

Make the local audio capture layer platform-aware so the same codebase runs on both macOS and Linux without user intervention. On macOS, continue using the VPIO binary (echo-cancelled mic + speaker through CoreAudio). On Linux, use PulseAudio/PipeWire CLI tools (`parec` for mic, `pacat` for speaker) with `module-echo-cancel` for AEC.

The platform is detected automatically at runtime via `process.platform`. No user configuration needed.

**Scope boundary:** This plan covers audio I/O only (mic capture + speaker playback). Local TTS (mlx-audio/Kokoro) remains macOS-only because MLX requires Apple Silicon. On Linux, users use ElevenLabs (cloud) for TTS. Local STT (sherpa-onnx/Whisper) is already cross-platform and just needs its metadata updated.

## File Tree

```
sidecar/
  audio-capture.ts              (MODIFIED) Platform dispatcher -- delegates to darwin or linux module, keeps bufferToFloat32
  audio-capture-darwin.ts       (NEW)      Extracted macOS VPIO implementation (current audio-capture.ts code)
  audio-capture-linux.ts        (NEW)      Linux implementation using parec/pacat with echo-cancel source
  local-audio.ts                (MODIFIED) Platform-aware chime playback
  stt-provider.ts               (MODIFIED) Remove requiresPlatform: "darwin" from local STT metadata (sherpa-onnx works on Linux)
  assets/chime.wav              (NEW)      Small bundled chime WAV for Linux playback (~10KB)
scripts/
  setup-local-tts.js            (-)        Unchanged -- stays macOS-only (mlx-audio requires Apple Silicon)
package.json                    (MODIFIED) Add "linux" to os array
```

Notes:
- `tts-provider.ts` and `scripts/setup-local-tts.js` remain unchanged. Local TTS genuinely requires macOS for mlx-audio model inference. The `requiresPlatform: "darwin"` and platform gate in those files are correct.
- `sidecar/chime.ts` (used by Twilio and browser-call adapters) calls `afconvert` (macOS-only). This is out of scope for this plan since those adapters are separate transports, but should be addressed if those adapters are ported to Linux later.

## Per-File Methods and Types

### audio-capture.ts (MODIFIED)

Becomes a platform dispatcher. Keeps `bufferToFloat32` (platform-agnostic utility) and the `AudioIO` type. Delegates all audio I/O to the platform-specific module based on `process.platform`.

#### Types

```
AudioIO {
  micStream: Readable       // echo-cancelled mic PCM (16-bit signed, mono)
  speakerInput: Writable    // TTS PCM for playback (16-bit signed, mono)
}
```

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `startCapture` | `micRate: number, speakerRate: number` | `Promise<AudioIO>` | Checks `process.platform` and delegates to `startCaptureDarwin` or `startCaptureLinux`. Throws on unsupported platform. |
| `stopCapture` | none | `void` | Delegates to the active platform module's stop function. |
| `interruptPlayback` | none | `void` | Delegates to the active platform module's interrupt function. |
| `resumePlayback` | none | `void` | Delegates to the active platform module's resume function. |
| `isCapturing` | none | `boolean` | Returns whether audio I/O is active. |
| `bufferToFloat32` | `buffer: Buffer` | `Float32Array` | Pure conversion: 16-bit signed PCM to normalized float. Unchanged. |

### audio-capture-darwin.ts (NEW)

Extracted from current `audio-capture.ts`. All macOS-specific VPIO logic moves here unchanged.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `startCaptureDarwin` | `micRate: number, speakerRate: number` | `Promise<AudioIO>` | Spawns the `mic-vpio` binary, waits for READY on stderr, returns AudioIO with stdout as micStream and stdin as speakerInput. |
| `stopCaptureDarwin` | none | `void` | Kills the mic-vpio child process. |
| `interruptPlaybackDarwin` | none | `void` | Sends SIGUSR1 to mic-vpio (clears ring buffer, starts discarding stdin). |
| `resumePlaybackDarwin` | none | `void` | Sends SIGUSR2 to mic-vpio (stops discarding stdin). |

### audio-capture-linux.ts (NEW)

Linux audio I/O using PulseAudio/PipeWire CLI tools. Uses two child processes: `parec` for mic capture and `pacat` for speaker playback. Uses a gated PassThrough stream for the speaker to support interrupt/resume without changing the Writable reference held by callers.

#### Types

```
LinuxAudioState {
  parecProcess: ChildProcess | null    // mic capture process
  pacatProcess: ChildProcess | null    // speaker playback process
  speakerGate: GatedWritable           // stable Writable reference for callers (custom Writable subclass)
  discarding: boolean                  // when true, GatedWritable drops writes silently
  echoSourceName: string               // PulseAudio echo-cancel source name for parec --device
  echoSinkName: string                 // PulseAudio echo-cancel sink name for pacat --device
  speakerRate: number                  // stored for pacat respawn on resume
}
```

`GatedWritable` is a custom `Writable` subclass (NOT a literal PassThrough). It holds an internal reference to the current `pacat.stdin` and writes to it directly inside `_write`. It does NOT use `pipe()`.

- Normal mode: `_write(chunk, encoding, callback)` calls `this.pacatStdin.write(chunk, callback)`. If `pacatStdin.write()` returns false, waits for `drain` before invoking callback.
- Discard mode: `_write(chunk, encoding, callback)` invokes `callback()` synchronously without writing. Returns `true` (buffer not full) so callers never block on `drain`.
- On resume: `setPacatStdin(newStdin)` swaps the internal reference. On interrupt: `setDiscarding(true)` + catches and swallows any pending write errors from the old (killed) pacat stdin.

#### Methods

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `startCaptureLinux` | `micRate: number, speakerRate: number` | `Promise<AudioIO>` | Checks for `parec`/`pacat` on PATH (throws with install instructions if missing). Detects echo-cancel source+sink via `pactl list short sources/sinks` matching `voicecc_echo_source`/`voicecc_echo_sink` (throws if not loaded). Spawns both processes with `--device` targeting the echo-cancel devices. Validates mic produces data within a timeout. Returns AudioIO with parec stdout as micStream and the GatedWritable as speakerInput. |
| `stopCaptureLinux` | none | `void` | Sets `discarding = true` on the GatedWritable (prevents ERR_STREAM_DESTROYED on in-flight writes), then kills both child processes. |
| `interruptPlaybackLinux` | none | `void` | Sets `discarding = true` on the GatedWritable (silently drops writes, catches errors from dying pacat stdin). Kills the `pacat` process to stop playback immediately. |
| `resumePlaybackLinux` | none | `void` | Spawns a fresh `pacat` process (targeting stored `echoSinkName` and `speakerRate`), calls `speakerGate.setPacatStdin(newPacat.stdin)`, sets `discarding = false`. |

### local-audio.ts (MODIFIED)

Only change: `playChime` becomes platform-aware.

#### Methods (changed only)

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `playChime` | none | `void` | On macOS: `afplay /System/Library/Sounds/Glass.aiff` (unchanged). On Linux: `paplay sidecar/assets/chime.wav`. |

### stt-provider.ts (MODIFIED)

#### Methods (changed only)

| Method | Arguments | Returns | Description |
|--------|-----------|---------|-------------|
| `getAvailableSttProviders` | none | `SttProviderInfo[]` | Remove `requiresPlatform: "darwin"` from the local Whisper entry. sherpa-onnx-node supports Linux. |

### package.json (MODIFIED)

Change `"os": ["darwin"]` to `"os": ["darwin", "linux"]`.

## Technical Notes

### Linux audio capture via parec/pacat

`parec` and `pacat` are PulseAudio CLI tools that also work on PipeWire (via PipeWire's PulseAudio compatibility layer, default on modern Ubuntu 22.04+ and Fedora).

Mic capture command:
```bash
parec --format=s16le --rate=16000 --channels=1 --raw
```
Outputs raw 16-bit signed little-endian PCM to stdout. Same format as mic-vpio.

Speaker playback command:
```bash
pacat --format=s16le --rate=24000 --channels=1 --raw --playback
```
Reads raw PCM from stdin and plays it.

Both stream continuously -- no file I/O needed. Install via `sudo apt install pulseaudio-utils`.

### Echo cancellation on Linux (required)

Without echo cancellation, TTS playback feeds into the mic, the VAD detects it as speech, and the system enters a feedback loop. Echo cancellation is NOT optional.

PulseAudio provides `module-echo-cancel` which uses the WebRTC AEC engine. When loaded, it creates virtual source/sink devices. The `parec` command targets the echo-cancelled source via `--device`:

```bash
pactl load-module module-echo-cancel aec_method=webrtc source_name=voicecc_echo_source sink_name=voicecc_echo_sink
parec --device=voicecc_echo_source --format=s16le --rate=16000 --channels=1 --raw
pacat --device=voicecc_echo_sink --format=s16le --rate=24000 --channels=1 --raw --playback
```

Both `parec` AND `pacat` must target the echo-cancel devices. The AEC engine only has a reference signal if playback goes through the echo-cancel sink. If `pacat` writes to the default sink, the AEC has no reference and does nothing.

The `startCaptureLinux` function must:
1. Check if the echo-cancel source exists via `pactl list short sources` matching exact name `voicecc_echo_source`
2. Check if the echo-cancel sink exists via `pactl list short sinks` matching exact name `voicecc_echo_sink`
3. If either is missing, throw with instructions: `pactl load-module module-echo-cancel aec_method=webrtc source_name=voicecc_echo_source sink_name=voicecc_echo_sink`
4. Target the echo-cancel source with `--device` on `parec`, and the echo-cancel sink with `--device` on `pacat`
5. Store both device names in `LinuxAudioState` so `resumePlaybackLinux` can respawn `pacat` with the same device

### GatedWritable for interrupt/resume

The `speakerInput` Writable returned in AudioIO must remain a stable reference (callers hold onto it). On Linux we use `GatedWritable`, a custom `Writable` subclass that holds a reference to the current `pacat.stdin` and writes to it directly inside `_write()`. It does NOT use `pipe()` (only Readable streams can be piped, and the gated stream is a write destination).

- Normal mode: `_write(chunk, encoding, cb)` calls `this.pacatStdin.write(chunk, cb)`
- Discard mode: `_write(chunk, encoding, cb)` calls `cb()` synchronously -- data is dropped, caller never blocks on `drain`
- On resume: `setPacatStdin(newStdin)` swaps the internal reference to the new `pacat` process stdin
- On interrupt: catches and swallows any pending write errors from the old (killed) `pacat.stdin` callback, preventing `writeSpeaker` in `local-audio.ts` from hanging forever on an unresolved write promise

### Error handling for parec/pacat

Both processes can fail if the PulseAudio/PipeWire daemon is not running or audio devices change. The implementation must:
- Listen for `error` and `exit` events on both child processes
- If `parec` exits unexpectedly, emit an error on micStream so the voice session shuts down cleanly
- If `pacat` exits outside of an explicit interrupt cycle, log a warning and attempt to respawn
- On startup, validate that `parec` produces at least one data chunk within a timeout (similar to the macOS `waitForReady` pattern)
- If `module-echo-cancel` is unloaded while the session is running, `parec` may silently produce silence or exit -- the `parec` exit handler should surface this clearly rather than silently failing

### Interrupt latency on Linux

On macOS, SIGUSR1 clears the VPIO ring buffer atomically -- interruption is near-instant. On Linux, killing `pacat` closes the PulseAudio stream, but the daemon may play its remaining internal buffer (~20-50ms). This small latency difference is acceptable and documented.

### Portable command check

The existing `commandExists` helper in `setup-local-tts.js` uses `which`. For better portability across Linux distros (some don't ship `which` by default), use `command -v` instead. This also applies to the command checks in `startCaptureLinux`.

## Phases

### Phase 1: Extract macOS code ✅
- [x] Create `audio-capture-darwin.ts` by moving all macOS-specific code from `audio-capture.ts`
- [x] Export `startCaptureDarwin`, `stopCaptureDarwin`, `interruptPlaybackDarwin`, `resumePlaybackDarwin`
- [x] Rewrite `audio-capture.ts` as the platform dispatcher that imports from darwin module and delegates
- [x] Keep `bufferToFloat32` and `AudioIO` type in `audio-capture.ts`
- [x] Verify existing macOS behavior is unchanged (run `npm start`)

### Phase 2: Linux audio capture ✅
- [x] Create `audio-capture-linux.ts` with `parec`/`pacat` spawning logic
- [x] Implement echo-cancel source detection via `pactl`
- [x] Implement gated PassThrough for stable speakerInput reference with discard flag
- [x] Implement `startCaptureLinux` with startup validation (parec produces data within timeout)
- [x] Implement `stopCaptureLinux` killing both processes
- [x] Implement `interruptPlaybackLinux` (set discard flag, kill pacat) and `resumePlaybackLinux` (respawn pacat, clear discard flag)
- [x] Add error/exit handlers on both child processes
- [x] Wire linux module into `audio-capture.ts` dispatcher via `process.platform` check

### Phase 3: Update peripheral files ✅
- [x] Update `local-audio.ts` playChime to branch on platform (`afplay` on macOS, `paplay` on Linux)
- [x] Add `sidecar/assets/chime.wav` (small WAV file, ~27KB)
- [x] Update `stt-provider.ts`: remove `requiresPlatform: "darwin"` from local Whisper metadata
- [x] Add `"linux"` to `package.json` os array
- [x] Update `commandExists` helper to use `command -v` instead of `which`

### Phase 4: Test on Linux
- [ ] Test `parec`/`pacat` spawning and PCM streaming on an Ubuntu machine
- [ ] Test echo cancellation with `module-echo-cancel` loaded
- [ ] Test interrupt/resume cycle (kill pacat, respawn, verify new audio plays, verify no stale audio)
- [ ] Test error handling when PulseAudio daemon is not running
- [ ] Test full voice loop with ElevenLabs TTS + local STT on Linux

## Success Criteria

- macOS behavior is unchanged -- mic-vpio still used, no regressions
- On Linux, `npm install -g voicecc` succeeds (no os rejection)
- On Linux, `createLocalAudioAdapter()` spawns parec/pacat and returns working AudioIO streams
- Audio format contract is preserved: mic outputs 16-bit signed mono PCM at micRate, speaker accepts 16-bit signed mono PCM at speakerRate
- Interrupt/resume works on Linux (TTS playback stops, no stale audio after resume, new audio plays)
- Echo cancellation is enforced on Linux -- startup fails with clear error if module-echo-cancel is not loaded
- No platform-specific code leaks above the `audio-capture.ts` layer (local-audio.ts only has the chime difference)
- `sidecar/index.ts` requires zero changes
- Local STT (sherpa-onnx) shows as available on Linux in the dashboard
